---
---

<script is:inline type="module">
  const MERMAID_SRC = 'https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.esm.min.mjs';

  let mermaidPromise;

  function cssVar(name) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  function getThemeVariables() {
    return {
      fontFamily: cssVar('--font-sans') || 'sans-serif',
      primaryColor: cssVar('--color-bg-subtle'),
      primaryBorderColor: cssVar('--color-border'),
      primaryTextColor: cssVar('--color-text'),
      lineColor: cssVar('--color-border-hover') || cssVar('--color-border'),
      secondaryColor: cssVar('--color-bg-elevated'),
      tertiaryColor: cssVar('--color-bg'),
      noteBkgColor: cssVar('--color-bg-elevated'),
      noteBorderColor: cssVar('--color-border'),
      noteTextColor: cssVar('--color-text'),
    };
  }

  function getMermaidConfig() {
    const isLight = document.documentElement.classList.contains('light');
    return {
      startOnLoad: false,
      securityLevel: 'strict',
      theme: 'base',
      themeVariables: {
        ...getThemeVariables(),
        darkMode: !isLight,
      },
    };
  }

  async function loadMermaid() {
    if (!mermaidPromise) {
      mermaidPromise = import(MERMAID_SRC).then((mod) => mod.default);
    }
    return mermaidPromise;
  }

  function normalizeMermaidBlocks() {
    // Convert fenced code blocks (markdown) into mermaid containers.
    // Astro/Shiki often adds `data-language="..."` to the <pre>.
    const candidates = document.querySelectorAll(
      'pre[data-language="mermaid"], pre[data-lang="mermaid"], pre > code.language-mermaid, pre > code.lang-mermaid'
    );

    candidates.forEach((node) => {
      const pre = node instanceof HTMLPreElement ? node : node.closest('pre');
      if (!pre || pre.dataset.mermaidConverted === 'true') return;

      const source = (pre.textContent || '').trim();
      if (!source) return;

      const container = document.createElement('div');
      container.className = 'mermaid';
      container.dataset.mermaidSource = source;
      container.textContent = source;

      pre.replaceWith(container);
      container.dataset.mermaidConverted = 'true';
    });

    // Ensure inline .mermaid blocks keep their original source for re-rendering.
    document.querySelectorAll('.mermaid').forEach((el) => {
      const element = /** @type {HTMLElement} */ (el);
      if (!element.dataset.mermaidSource) {
        element.dataset.mermaidSource = (element.textContent || '').trim();
      }
    });
  }

  async function renderMermaid() {
    normalizeMermaidBlocks();
    const blocks = Array.from(document.querySelectorAll('.mermaid'));
    if (blocks.length === 0) return;

    const mermaid = await loadMermaid();
    mermaid.initialize(getMermaidConfig());

    blocks.forEach((block) => {
      const element = /** @type {HTMLElement} */ (block);
      const source = element.dataset.mermaidSource || '';
      if (!source) return;
      element.textContent = source;
      element.removeAttribute('data-processed');
    });

    try {
      await mermaid.run({ querySelector: '.mermaid' });
    } catch (err) {
      console.error('Mermaid render failed:', err);
    }
  }

  let scheduled = false;
  function scheduleRender() {
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(() => {
      scheduled = false;
      void renderMermaid();
    });
  }

  // Initial load + Astro view transitions
  scheduleRender();
  document.addEventListener('astro:after-swap', scheduleRender);

  // Re-render when theme toggles (html.light class changes)
  const observer = new MutationObserver(scheduleRender);
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });
</script>

