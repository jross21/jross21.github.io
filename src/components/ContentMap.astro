---
import TerminalPanel from './TerminalPanel.astro';

interface Heading {
  depth: number;
  slug: string;
  text: string;
}

interface Props {
  headings: Heading[];
  title?: string;
  rootLabel?: string;
  maxSections?: number;
  maxSubsections?: number;
  class?: string;
}

const {
  headings,
  title = 'At a Glance',
  rootLabel = 'Key Sections',
  maxSections = 8,
  maxSubsections = 4,
  class: className = '',
} = Astro.props;

function sanitizeLabel(text: string) {
  const cleaned = text
    .replace(/[\r\n]+/g, ' ')
    .replace(/[\[\]{}()"]/g, '')
    .replace(/\s+/g, ' ')
    .trim();

  if (cleaned.length <= 80) return cleaned;
  return `${cleaned.slice(0, 77)}â€¦`;
}

function buildMindmapDiagram() {
  const lines = ['mindmap', `  root((${sanitizeLabel(rootLabel)}))`];

  let sectionCount = 0;
  let hasSections = false;
  let currentSubsections = 0;
  let canAddSubsection = false;

  for (const heading of headings) {
    if (heading.depth === 2) {
      sectionCount += 1;
      if (sectionCount > maxSections) break;

      hasSections = true;
      currentSubsections = 0;
      canAddSubsection = true;
      lines.push(`    ${sanitizeLabel(heading.text)}`);
      continue;
    }

    if (heading.depth === 3 && canAddSubsection) {
      if (currentSubsections >= maxSubsections) continue;
      currentSubsections += 1;
      lines.push(`      ${sanitizeLabel(heading.text)}`);
    }
  }

  return hasSections ? lines.join('\n') : '';
}

const diagram = buildMindmapDiagram();
---

{diagram && (
  <TerminalPanel title={title} class={className}>
    <div class="mermaid">{diagram}</div>
  </TerminalPanel>
)}

