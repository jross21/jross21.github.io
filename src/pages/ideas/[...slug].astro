---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TerminalPanel from '../../components/TerminalPanel.astro';
import CoreClaimsBox from '../../components/CoreClaimsBox.astro';
import FileExplorer from '../../components/FileExplorer.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import RelatedItems from '../../components/RelatedItems.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const writing = await getCollection('writing');
  return writing.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();

// Get all writing for related items
const allWriting = await getCollection('writing');
const relatedPosts = allWriting
  .filter(p => p.slug !== entry.slug)
  .slice(0, 3)
  .map(p => ({ title: p.data.title, slug: p.slug, type: 'writing' as const }));
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <article class="py-8">
    <!-- Two-column layout -->
    <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-8">
      <!-- Main content column -->
      <div>
        <!-- Header -->
        <div class="mb-8">
          <!-- Category tag -->
          {entry.data.category && (
            <div class="text-xs text-[var(--color-text-dim)] mb-3 uppercase tracking-wide">
              {entry.data.category}
            </div>
          )}

          <h1 class="text-2xl md:text-3xl font-bold text-[var(--color-text)] mb-4">
            {entry.data.title}
          </h1>

          <p class="text-lg text-[var(--color-text-muted)] leading-relaxed">
            {entry.data.description}
          </p>
        </div>

        <!-- Core Claims -->
        {entry.data.coreClaims && entry.data.coreClaims.length > 0 && (
          <CoreClaimsBox claims={entry.data.coreClaims} />
        )}

        <!-- Table of Contents (mobile) -->
        {headings.length > 0 && (
          <div class="lg:hidden mb-6">
            <TerminalPanel title="Contents" collapsible={true} defaultOpen={false}>
              <FileExplorer headings={headings} />
            </TerminalPanel>
          </div>
        )}

        <!-- Content -->
        <div class="prose prose-neutral dark:prose-invert max-w-[70ch]
          prose-headings:text-[var(--color-text)] prose-headings:font-semibold
          prose-p:text-[var(--color-text)] prose-p:leading-relaxed
          prose-a:text-[var(--color-accent)] prose-a:no-underline hover:prose-a:underline
          prose-strong:text-[var(--color-text)] prose-strong:font-semibold
          prose-code:text-[var(--color-text)] prose-code:bg-[var(--color-bg-subtle)]
          prose-pre:bg-[var(--color-bg-subtle)] prose-pre:border prose-pre:border-[var(--color-border)]
          prose-li:text-[var(--color-text-muted)]
          prose-ul:text-[var(--color-text-muted)]
          prose-ol:text-[var(--color-text-muted)]
          prose-td:text-[var(--color-text-muted)]
          prose-th:text-[var(--color-text)]">
          <Content />
        </div>
      </div>

      <!-- Sidebar -->
      <aside class="hidden lg:block space-y-6">
        <!-- File Explorer TOC -->
        {headings.length > 0 && (
          <TerminalPanel title="Contents">
            <FileExplorer headings={headings} />
          </TerminalPanel>
        )}

        <!-- Author Card -->
        <AuthorCard />

        <!-- Related Posts -->
        {relatedPosts.length > 0 && (
          <TerminalPanel title="Related">
            <RelatedItems items={relatedPosts} title="More writing" />
          </TerminalPanel>
        )}
      </aside>
    </div>

    <!-- Mobile sidebar content -->
    <div class="lg:hidden mt-8 space-y-6">
      <AuthorCard />
      {relatedPosts.length > 0 && (
        <TerminalPanel title="Related">
          <RelatedItems items={relatedPosts} title="More writing" />
        </TerminalPanel>
      )}
    </div>
  </article>
</BaseLayout>
