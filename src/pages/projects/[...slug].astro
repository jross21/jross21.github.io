---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TerminalPanel from '../../components/TerminalPanel.astro';
import FileExplorer from '../../components/FileExplorer.astro';
import AuthorCard from '../../components/AuthorCard.astro';
import DownloadSection from '../../components/DownloadSection.astro';
import RelatedItems from '../../components/RelatedItems.astro';
import GitStats from '../../components/GitStats.astro';
import ReadingProgress from '../../components/ReadingProgress.astro';
import ArticleNav from '../../components/ArticleNav.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import TieredRoutingDiagram from '../../components/graphics/diagrams/TieredRoutingDiagram.astro';
import DataFlowDiagram from '../../components/graphics/diagrams/DataFlowDiagram.astro';
import BeforeAfterComparison from '../../components/graphics/diagrams/BeforeAfterComparison.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const work = await getCollection('work');
  return work.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content, headings } = await entry.render();
const summary = entry.data.summary;

// Get all projects for related items + prev/next navigation
const allWork = await getCollection('work');
const currentIndex = allWork.findIndex(p => p.slug === entry.slug);
const prev = currentIndex > 0
  ? { title: allWork[currentIndex - 1].data.title, slug: allWork[currentIndex - 1].slug }
  : undefined;
const next = currentIndex < allWork.length - 1
  ? { title: allWork[currentIndex + 1].data.title, slug: allWork[currentIndex + 1].slug }
  : undefined;

const relatedProjects = allWork
  .filter(p => p.slug !== entry.slug)
  .slice(0, 3)
  .map(p => ({ title: p.data.title, slug: p.slug, type: 'project' as const }));

const stats = entry.data.stats;
---

<BaseLayout title={entry.data.title} description={entry.data.description}>
  <ReadingProgress section="projects" />

  <article class="py-8" data-section="projects">
    <!-- Breadcrumb -->
    <div class="mb-6">
      <Breadcrumb items={[
        { label: 'projects', href: '/projects' },
        { label: entry.slug }
      ]} />
    </div>

    <!-- Two-column layout -->
    <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-8">
      <!-- Main content column -->
      <div>
        <!-- Header panel -->
        <TerminalPanel title="Overview" class="mb-6">
          <div class="space-y-4">
            <!-- Title -->
            <h1 class="text-2xl md:text-3xl font-bold text-[var(--color-text)]">
              {entry.data.title}
            </h1>

            <!-- Description -->
            <p class="text-[var(--color-text-muted)] leading-relaxed">
              {entry.data.description}
            </p>

            {stats && stats.length > 0 && (
              <div class="pt-2 border-t border-[var(--color-border)]">
                <GitStats stats={stats} />
              </div>
            )}
          </div>
        </TerminalPanel>

        {summary && (
          <TerminalPanel title="Transformation" class="mb-6">
            <dl class="space-y-4 text-sm text-[var(--color-text-muted)]">
              <div>
                <dt class="text-[var(--color-text)]">Outcome</dt>
                <dd>{summary.outcome}</dd>
              </div>
              <div>
                <dt class="text-[var(--color-text)]">Context</dt>
                <dd>{summary.context}</dd>
              </div>
              <div>
                <dt class="text-[var(--color-text)]">Change</dt>
                <dd>{summary.change}</dd>
              </div>
            </dl>
          </TerminalPanel>
        )}

        <!-- Case Study Diagrams -->
        {entry.slug === 'ai-routing-sla' && (
          <TerminalPanel title="System Architecture" class="mb-6">
            <TieredRoutingDiagram autoPercent={40} assistedPercent={45} humanPercent={15} />
          </TerminalPanel>
        )}

        {entry.slug === 'self-serve-analytics' && (
          <TerminalPanel title="Data Architecture" class="mb-6">
            <DataFlowDiagram sources={['CRM', 'Marketing', 'Product', 'Finance']} />
          </TerminalPanel>
        )}

        {entry.slug === 'data-governance-automation' && (
          <TerminalPanel title="Impact" class="mb-6">
            <BeforeAfterComparison
              metrics={[
                { label: 'Required Fields Complete', before: '64%', after: '92%', improvement: '+28%' },
                { label: 'Duplicate Rate', before: 'High', after: 'Low', improvement: '-78%' },
                { label: 'Lead Source Onboarding', before: '2 weeks', after: '4 days', improvement: '-70%' },
              ]}
            />
          </TerminalPanel>
        )}

        <!-- Table of Contents as File Explorer (mobile) -->
        {headings.length > 0 && (
          <div class="lg:hidden mb-6">
            <TerminalPanel title="Contents" collapsible={true} defaultOpen={false}>
              <FileExplorer headings={headings} />
            </TerminalPanel>
          </div>
        )}

        <!-- Content -->
        <div class="prose prose-neutral dark:prose-invert max-w-[70ch]
          prose-headings:text-[var(--color-text)] prose-headings:font-semibold
          prose-p:text-[var(--color-text)] prose-p:leading-relaxed
          prose-a:text-[var(--color-accent)] prose-a:no-underline hover:prose-a:underline
          prose-strong:text-[var(--color-text)] prose-strong:font-semibold
          prose-code:text-[var(--color-text)] prose-code:bg-[var(--color-bg-subtle)]
          prose-pre:bg-[var(--color-bg-subtle)] prose-pre:border prose-pre:border-[var(--color-border)]
          prose-li:text-[var(--color-text-muted)]
          prose-ul:text-[var(--color-text-muted)]
          prose-ol:text-[var(--color-text-muted)]
          prose-td:text-[var(--color-text-muted)]
          prose-th:text-[var(--color-text)]">
          <Content />
        </div>

        <!-- Prev/Next Navigation -->
        <ArticleNav prev={prev} next={next} basePath="/projects" />
      </div>

      <!-- Sidebar -->
      <aside class="hidden lg:block space-y-6">
        <!-- File Explorer TOC -->
        {headings.length > 0 && (
          <TerminalPanel title="Contents">
            <FileExplorer headings={headings} />
          </TerminalPanel>
        )}

        <!-- Author Card -->
        <AuthorCard />

        <!-- Download/CTA -->
        <DownloadSection
          title="Questions?"
          description="Want to walk through the system design or outcomes?"
          ctaText="Start a conversation"
          ctaHref="/contact"
        />

        <!-- Related Projects -->
        {relatedProjects.length > 0 && (
          <TerminalPanel title="Related">
            <RelatedItems items={relatedProjects} title="See also" />
          </TerminalPanel>
        )}
      </aside>
    </div>

    <!-- Mobile sidebar content -->
    <div class="lg:hidden mt-8 space-y-6">
      <AuthorCard />
      <DownloadSection
        title="Questions?"
        description="Want to walk through the system design or outcomes?"
        ctaText="Start a conversation"
        ctaHref="/contact"
      />
      {relatedProjects.length > 0 && (
        <TerminalPanel title="Related">
          <RelatedItems items={relatedProjects} title="See also" />
        </TerminalPanel>
      )}
    </div>
  </article>
</BaseLayout>
